# 36: t-SNE Manifold Structure

## Motivation

PCA analysis (doc 35) showed that the offset (discrimination signal) is spread across 9 principal components, with PC1-PC2 capturing only 58% of offset variance. Linear projections inevitably lose structure. t-SNE provides a nonlinear embedding that can capture the full 16D geometry in 2D, revealing clustering and neighborhood structure that PCA misses.

## Final Hidden States

t-SNE was applied to all 180 final hidden states (90 position pairs × fwd/rev).

### Fwd vs Rev Separation

In t-SNE space, forward and reverse hidden states form **clearly separated clusters**. This is stronger than what PCA showed — in PCA PC1-PC2 the two populations largely overlap, but the full 16D geometry contains enough information to distinguish them.

The purple arrows connecting paired fwd/rev states show consistent directionality, confirming the offset has a structured direction in the full hidden space.

### Gap as Primary Organizer

Coloring by position gap |m_pos - s_pos| reveals that **gap is the dominant organizing principle** of the hidden state manifold:

- Small gaps (1-2) cluster tightly
- Large gaps (7-9) spread out, occupying more of the manifold

This matches the circuit's behavior: small-gap pairs produce similar dynamics (harder discrimination), while large-gap pairs produce more diverse hidden states.

### M Position Clustering

Coloring by M position shows that **each M position forms a distinct cluster**. The first impulse position defines a neighborhood on the manifold, and the second impulse (S) moves the state within that neighborhood. This is consistent with the "first to fire, first to wire" mechanism (doc 34) — the M impulse sets up the initial dynamics, and the S impulse modulates within that regime.

## Offset Vectors

t-SNE was applied directly to the 90 offset vectors (h_fwd - h_rev), revealing the geometry of the discrimination signal.

### Gap Organizes Offset Space

Offset vectors with similar gaps cluster together. The offset magnitude and direction are primarily determined by how far apart the two impulses are, not by their absolute positions.

### Margin Maps to Offset Geometry

Coloring by discrimination margin reveals spatial organization: **hard cases (low margin) cluster together**, separated from easy cases (high margin). The difficulty of a position pair is encoded in the geometry of its offset vector.

This has a practical implication: the circuit's failure modes are not random — they correspond to a specific region of offset space, likely where within-cell variation is insufficient to push past the readout threshold.

### Answer Position Clustering

The most striking finding: **offset vectors cluster by s_pos (the correct answer)**. Each answer position occupies a distinct region of the offset manifold.

This means the 16D offset doesn't just encode "which is bigger" — it encodes **which position is the answer**. The full-dimensional offset contains position-specific information that W_out reads out. PCA's 2D projection obscured this because the position-specific structure spans many PCs.

## Trajectory Dynamics

t-SNE was applied to trajectory states from 5 example pairs (10 timesteps × 2 directions × 5 pairs = 100 states).

### Temporal Structure

The embedding shows clear temporal progression — early timesteps (t=1-3, after the first impulse) occupy one region, while late timesteps (t=8-10, approaching readout) occupy another. The hidden state dynamics follow a structured path through the manifold, not a random walk.

### Fwd/Rev Divergence

Trajectory pairs (solid=fwd, dashed=rev) start together at t=0, track similarly for the first few steps, then diverge. The divergence point corresponds to when the second impulse arrives, confirming that the offset is generated by the differential response to the second impulse.

## Connection to Tropical Geometry

The t-SNE results complement the tropical analysis:

1. **Tropical cells → t-SNE clusters**: The 38 tropical cells identified at S=0.8 likely correspond to the cluster structure visible in t-SNE. Points in the same tropical cell share an activation pattern and are in the same affine region.

2. **Within-cell variation → cluster spread**: The 73% within-cell offset component explains why t-SNE clusters have internal structure. Points within one cluster (cell) vary continuously in their affine outputs.

3. **Answer clustering → W_out alignment**: The offset clustering by s_pos reflects that W_out is tuned to read different answer positions from different regions of offset space. This is the geometric realization of the readout mechanism.

## Key Takeaways

1. **The 16D hidden state is more structured than PCA suggests**. Fwd/rev are well-separated, gap organizes the manifold, and M position defines clusters. Linear projections lose this.

2. **The offset encodes the answer position**, not just a scalar margin. Each s_pos has its own region in offset space.

3. **Difficulty is geometric** — hard cases cluster together in offset space, suggesting systematic (not random) failure modes.

4. **Temporal dynamics are structured** — trajectories follow organized paths that diverge at the second impulse.

5. **9 PCs of offset variance** manifest as rich cluster structure that a 2D linear projection cannot capture.

## Visualizations

- `docs/umap_tsne_final_states.png` — Final states colored by direction, gap, M position
- `docs/umap_tsne_offsets.png` — Offset vectors colored by gap, margin, answer
- `docs/umap_tsne_trajectories.png` — Trajectory embeddings colored by time and pair

## Related Documents

- [35: Tropical Geometry Lens](35_tropical_geometry_lens.md) — PCA spectrum, tropical cells, offset decomposition
- [33: Offset Discrimination Mechanism](33_offset_discrimination_mechanism.md) — Separable offset structure
- [34: Fwd/Rev Mechanism Explained](34_fwd_rev_mechanism_explained.md) — "First to fire, first to wire"
