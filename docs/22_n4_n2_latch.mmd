%%{ init: { "theme": "base", "themeVariables": { "fontSize": "14px" } } }%%
flowchart TD
    subgraph INPUT["Sequential Input (t = 0..9)"]
        2AM["2AM impulse (mag 0.8) at position S"]
        1AM["1AM impulse (mag 1.0) at position M > S"]
    end

    subgraph DETECTOR["n4 — One-Shot Impulse Detector<br/>W_ih = +10.16, W_hh[4,4] = -0.99"]
        n4_fire1["t = S: n4 fires (8.13)<br/>from zero state, pure input kick"]
        n4_die1["t = S+1: n4 dies<br/>(negative self-recurrence)"]
        n4_fire2["t = M: n4 fires SUPPRESSED (3.00)<br/>input +10.16, but recurrent -7.16<br/>from n2 negative feedback"]
        n4_die2["t = M+1: n4 dies again"]
    end

    subgraph LATCH["n2 — Memory Latch<br/>W_ih = +0.015, W_hh[2,2] = +0.97"]
        n2_load["t = S+1: n2 loads 2AM signal<br/>n4 × W_hh[2,4] = 8.13 × 1.73 = 14.09"]
        n2_hold["t = S+2 .. M-1: n2 holds<br/>0.97 decay per step"]
        n2_survive["t = M: n2 survives 1AM kick<br/>W_ih = +0.015 → adds only +0.02"]
        n2_boost["t = M+1: n2 boosted to 18.67<br/>self (13.56) + attenuated n4 (5.19)"]
    end

    subgraph FEEDBACK["Negative Feedback<br/>W_hh[4,2] = -0.49"]
        fb["n2 (14.67) → n4: -7.22<br/>Suppresses n4 response to 1AM<br/>= automatic gain control"]
    end

    subgraph WAVES["Wave Neurons (n0, n10, n11, n12, n14)<br/>|W_ih| < 1.3"]
        wave_carry["Waves carry 2AM cascade<br/>recurrent state ~11"]
        wave_survive["1AM kick: |input/recur| ≈ 0.01<br/>Waves sail through unaffected"]
    end

    subgraph COMPS["Comparators (n1, n6, n7, n8)<br/>W_ih ≈ -10 to -13"]
        comp_clip1["t = S: 2AM clips comps"]
        comp_rebuild1["t = S+1..M-1: comps rebuild"]
        comp_clip2["t = M: 1AM clips ALL comps to 0<br/>(2AM signal in comps destroyed)"]
        comp_rebuild2["t = M+1..9: comps rebuild from<br/>n2 + n4 + wave feedback"]
    end

    subgraph SELECTIVE["Selective Cancellation in Comps"]
        n7_cancel["n7: n2 (+9.43) + n4 (-9.42) = ~0<br/>→ n7 encodes only 1AM position"]
        n8_retain["n8: n2 (+8.74) + n4 (-5.92) = +2.82<br/>→ n8 retains 2AM information"]
        n6_retain["n6: n2 (+7.48) + n4 (-3.60) = +3.88<br/>→ n6 retains 2AM information"]
    end

    subgraph READOUT["W_out Readout"]
        answer["Correct logit at 2AM position<br/>100% accuracy on reversed pairs"]
    end

    %% Signal flow
    2AM --> n4_fire1
    n4_fire1 --> n4_die1
    n4_fire1 -->|"× W_hh[2,4] = 1.73"| n2_load
    n2_load --> n2_hold
    n2_hold --> n2_survive

    %% Cascade to waves and comps
    n4_fire1 --> comp_clip1
    2AM --> comp_clip1
    comp_clip1 --> comp_rebuild1
    comp_rebuild1 -->|"W_hh cascade"| wave_carry

    %% 1AM arrives
    1AM --> n4_fire2
    1AM --> comp_clip2
    n2_hold -.->|"W_hh[4,2] = -0.49"| fb
    fb -.-> n4_fire2
    n4_fire2 --> n4_die2
    n4_fire2 -->|"attenuated × 1.73 = 5.19"| n2_boost
    n2_survive --> n2_boost

    %% Waves survive
    wave_carry --> wave_survive
    1AM -.->|"tiny W_ih"| wave_survive

    %% Rebuild
    comp_clip2 --> comp_rebuild2
    n2_boost -->|"W_hh[comp,2] ≈ 0.5–0.67"| comp_rebuild2
    n4_die2 -->|"W_hh[comp,4]"| comp_rebuild2
    wave_survive --> comp_rebuild2

    %% Selective cancellation
    comp_rebuild2 --> n7_cancel
    comp_rebuild2 --> n8_retain
    comp_rebuild2 --> n6_retain

    %% Readout
    n7_cancel --> answer
    n8_retain --> answer
    n6_retain --> answer
    wave_survive --> answer
